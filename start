pipeline {
    agent any
    environment {
        AWS_DEFAULT_REGION="us-east-1"
    }
    stages {
        stage('Start AWS EC2 Instance') {
            steps {
                sh 'chmod +x start_ec2_selenium.sh'
                sh './start_ec2_selenium.sh'
            }
        }
        stage('Start Selenium Grid in the EC2 Instance') {
            steps {
                sshagent (credentials: ['sfr-devops-ssh-selenium']){
                     // Transfer docker-compose file to EC2 instance
                    sh 'scp -o StrictHostKeyChecking=no docker-compose-seleniumgrid-ec2.yml ec2-user@11.0.1.102:/tmp'
                     // SSH into EC2 instance and start Docker
                    sh 'ssh -o StrictHostKeyChecking=no ec2-user@11.0.1.102 "docker-compose -f /tmp/docker-compose-seleniumgrid-ec2.yml up -d"'
                }
            }
        }
    }
}
